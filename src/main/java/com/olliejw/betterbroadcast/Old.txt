package com.olliejw.betterbroadcast;

import java.util.logging.Logger;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;

public class BetterBroadcast extends JavaPlugin {
    public final Logger logger = Logger.getLogger("Minecraft");

    @Override
    public void onDisable() {
    }
    @Override
    public void onEnable() {
        getConfig().options().copyDefaults(true);
        saveDefaultConfig();
    }

    public boolean onCommand(CommandSender sender, Command cmd, String Label, String args[]) {
        // Broadcast
        if (cmd.getName().equalsIgnoreCase("broadcast")) {
            if (args.length == 0) {
                // No arguments error
                String Error = getConfig().getString("ErrorMessage");
                Error = ChatColor.translateAlternateColorCodes('&', Error);
                sender.sendMessage(Error);
            }
            // Get message
            else {
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < args.length; i++) {
                    sb.append(args[i]).append(" ");
                }
                String messageToBroadcast = sb.toString().replace("-s", "").replace("-p", "");
                Bukkit.broadcastMessage(ChatColor.RED + "Raw Input: " + messageToBroadcast);

                // Change Console's name for the %sender% placeholder
                String senderName;
                if (sender.getName() == "CONSOLE") {
                    senderName = (getConfig().getString("ConsoleName"));
                } else {
                    // If it isn't console sending the message we will make the %sender% placeholder the user's name
                    senderName = sender.getName();
                }

                // Declare our prefix/suffix for later
                String Prefix = null;
                String Suffix = null;

                // Just says that we aren't using custom prefix/suffix as of now
                boolean cp = false, cs = false;

                // Check if we want to override config prefix/suffix
                  // Checks if we are using "-p" or "-s" and makes the
                  // arguments with those tags our prefix/suffix
                for(String arg : args) {
                    // If we have the custom prefix tag
                    if (arg.contains("-p")) {
                        Prefix = arg;
                        Bukkit.broadcastMessage(ChatColor.RED + "Raw Custom Prefix: " + Prefix);
                        cp = true;
                    }
                    // If we aren't using a custom prefix we will tell the broadcast to use the config default
                    else {
                        cp = false;
                        Bukkit.broadcastMessage(ChatColor.RED + "Raw Default Prefix: " + Prefix);
                    }
                    // If we have the custom suffix tag
                    if (arg.contains("-s")) {
                        Suffix = arg;
                        Bukkit.broadcastMessage(ChatColor.RED + "Raw Custom Suffix: " + Suffix);
                        cs = true;
                    }
                    // If we aren't using a custom suffix we will tell the broadcast to use the config default
                    else {
                        cs = false;
                        Bukkit.broadcastMessage(ChatColor.RED + "Raw Default Suffix: " + Suffix);
                    }
                }

                // Declare important parts
                String broadcast = null;
                Boolean useSuffix = getConfig().getBoolean("ShowSuffix");
                Boolean usePrefix = getConfig().getBoolean("ShowPrefix");

              // Note to self:
                // If we are using a custom suffix then we will

                // If we are using a custom suffix but not custom prefix
                if(cs) {
                    // Check config to see if we want a prefix
                      // [!] messageToBroadcast contains our custom suffix anyway
                    Bukkit.broadcastMessage(ChatColor.GREEN + "Using Custom Suffix");
                    if (usePrefix) {
                        // Set our message to broadcast. Removes "-s" tag.
                        broadcast = (Prefix + messageToBroadcast).replace("-s", "");
                        Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/ Default Prefix w/ Custom Suffix: " + broadcast);
                    }
                    else{
                        // Config says we don't want a Prefix but keeps our "-s" Suffix
                        broadcast = (messageToBroadcast).replace("-s", "");
                        Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/o Default Prefix w/ Custom Suffix: " + broadcast);
                    }
                }
                else {
                    Bukkit.broadcastMessage(ChatColor.GREEN + "Not Using Custom Suffix");
                    // Looks like we don't have a custom suffix. We'll just check if the config says we want one
                    if(useSuffix)
                        // Looks like we do want a config suffix. Just check if we want a prefix too
                        if (usePrefix) {
                            // We want a default Prefix and Suffix
                            broadcast = (Prefix + messageToBroadcast + Suffix);
                            Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/ Default Prefix w/ Default Suffix: " + broadcast);
                        }
                        else{
                            // We want a config Suffix but not Prefix
                            broadcast = (messageToBroadcast + Suffix);
                            Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/o Default Prefix w/ Custom Suffix: " + broadcast);
                        }
                }

                // Lets just repeat that process but for our prefix

                // We have a custom "-p" prefix
                if(cp) {
                    Bukkit.broadcastMessage(ChatColor.GREEN + "Using Custom Prefix");
                    // Check config to see if we want a suffix
                    // [!] messageToBroadcast contains our custom prefix anyway
                    if (useSuffix) {
                        // Set our message to broadcast. Removes "-p" tag.
                        broadcast = (Prefix + messageToBroadcast).replace("-p", "");
                        Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/ Default Suffix w/ Custom Prefix: " + broadcast);
                    }
                    else{
                        // We want a config Prefix but not Suffix
                        broadcast = (messageToBroadcast).replace("-p", "");
                        Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/o Default Suffix w/ Custom Prefix: " + broadcast);
                    }
                }
                else {
                    // Looks like we don't have a custom suffix. We'll just check if the config says we want one
                    if(usePrefix)
                        Bukkit.broadcastMessage(ChatColor.GREEN + "Using Default Prefix");
                        // Looks like we do want a config prefix. Just check if we want a suffix too
                        if (useSuffix) {
                            // We want a default Prefix and Suffix
                            broadcast = (Prefix + messageToBroadcast + Suffix);
                            Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/ Default Prefix w/ Default Suffix: " + broadcast);
                        }
                        else{
                            // We want a config Prefix but not Suffix
                            broadcast = (Prefix + messageToBroadcast);
                            Bukkit.broadcastMessage(ChatColor.GOLD + "Broadcast w/ Default Prefix w/o Default Suffix: " + broadcast);
                        }
                }

                // Looks as if we have a custom Prefix and Suffix
                if(cs && cp) {
                    // This is really simple because we don't need to ask the config for any details. We can just use what the command sender has given us.
                    // We will just remove those "-p" and "-s" tags from our final message
                    broadcast = (messageToBroadcast).replace("-p", "").replace("-s", "");
                    Bukkit.broadcastMessage(ChatColor.GREEN + "Using Custom Prefix and Custom Suffix");
                }
                // Send Final Broadcast
                // We will replace %sender% with our console name or player name
                // We will also use our beautiful "&" color codes too!
                Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', broadcast).replace("%sender%", sender.getName()));
            }
        }

        // Looks like we want to reload our config
        if (cmd.getName().equalsIgnoreCase("bbreload")) {
            // Is the user allowed to do this?
            if (sender.hasPermission(getConfig().getString("ReloadPerm")))
                // Phew. Looks like they are. We will try reload the config
                try {
                    // It worked! Reload the config
                    reloadConfig();
                    saveDefaultConfig();
                    // Just let 'em know we have done the job
                    String Reload = getConfig().getString("ReloadMessage");
                    Reload = ChatColor.translateAlternateColorCodes('&', Reload);
                    sender.sendMessage(Reload);
                } catch(Exception e) {
                    // Uh oh. Something has gone wrong. Lets tell the sender
                    sender.sendMessage(ChatColor.RED + "Failed to reload. Check syntax");
                }
            return true;
        }
    return true;
    }
}

